<!DOCTYPE html><meta charset="utf-8"><style>
    body {
        font: 10px sans-serif;
        shape-rendering: crispEdges;
    }
    .day {
        fill: #fff;
        stroke: #ccc;
    }
    .month {
        fill: none;
        stroke: #000;
        stroke-width: 2px;
    }
    .calendar-view .q0-10{fill: rgb(255, 255, 255)}
    .calendar-view .q1-10{fill: rgb(234,241,247)}
    .calendar-view .q2-10{fill: rgb(214,227,238)}
    .calendar-view .q3-10{fill: rgb(193,213,230)}
    .calendar-view .q4-10{fill: rgb(173,199,222)}
    .calendar-view .q5-10{fill: rgb(152,186,213)}
    .calendar-view .q6-10{fill: rgb(132,172,205)}
    .calendar-view .q7-10{fill: rgb(111,158,197)}
    .calendar-view .q8-10{fill: rgb(91,144,188)}
    .calendar-view .q9-10{fill: rgb(70,130,180)} /*steelblue*/
</style>
<body>
<span id="calendar-view"></span>
<script src="d3.v3.min.js"></script>
<script>
    var rawData = /*data_placeholder*/
["\
date,changeSize\n\
12/02/2013,57464\n\
13/02/2013,133038\n\
14/02/2013,292470\n\
15/02/2013,195956\n\
16/02/2013,1502\n\
17/02/2013,3384\n\
18/02/2013,154524\n\
19/02/2013,368900\n\
20/02/2013,248887\n\
21/02/2013,172543\n\
22/02/2013,113425\n\
23/02/2013,13503\n\
24/02/2013,835\n\
25/02/2013,144442\n\
26/02/2013,197055\n\
27/02/2013,147296\n\
28/02/2013,93596\n\
01/03/2013,115060\n\
02/03/2013,8542\n\
03/03/2013,8531\n\
04/03/2013,222168\n\
05/03/2013,137528\n\
06/03/2013,68047\n\
07/03/2013,138364\n\
08/03/2013,56306\n\
09/03/2013,1747\n\
",
"\
date,changeSize\n\
12/02/2013,123\n\
13/02/2013,133038\n\
14/02/2013,292470\n\
15/02/2013,195956\n\
16/02/2013,1502\n\
17/02/2013,3384\n\
18/02/2013,154524\n\
19/02/2013,0\n\
20/02/2013,0\n\
21/02/2013,172543\n\
22/02/2013,113425\n\
23/02/2013,13503\n\
24/02/2013,835\n\
25/02/2013,144442\n\
26/02/2013,197055\n\
27/02/2013,147296\n\
28/02/2013,93596\n\
01/03/2013,115060\n\
02/03/2013,8542\n\
03/03/2013,8531\n\
04/03/2013,222168\n\
05/03/2013,137528\n\
06/03/2013,68047\n\
07/03/2013,138364\n\
08/03/2013,56306\n\
09/03/2013,1747\n\
",
"\
date,changeSize\n\
12/02/2013,123\n\
13/02/2013,133038\n\
14/02/2013,292470\n\
15/02/2013,195956\n\
16/02/2013,1502\n\
17/02/2013,3384\n\
18/02/2013,154524\n\
19/02/2013,0\n\
20/02/2013,0\n\
21/02/2013,172543\n\
22/02/2013,113425\n\
23/02/2013,13503\n\
24/02/2013,835\n\
25/02/2013,144442\n\
26/02/2013,197055\n\
27/02/2013,147296\n\
28/02/2013,93596\n\
01/03/2013,115060\n\
02/03/2013,8542\n\
03/03/2013,8531\n\
04/03/2013,222168\n\
05/03/2013,137528\n\
06/03/2013,68047\n\
07/03/2013,138364\n\
08/03/2013,56306\n\
09/03/2013,1747\n\
"
]
/*data_placeholder*/;

    function drawCalendarChart(elementId, rawData) {
        var threshold = 95;
        var rawDataIndex = 0;
        var data = parseRawData(rawData[rawDataIndex], threshold);

        var width = 960,
            height = 136,
            cellSize = 17;

        var day = d3.time.format("%w"),
            week = d3.time.format("%U");
        var dateFormat = d3.time.format("%d/%m/%Y");
        var valueFormat = function(n) {
            var s = d3.format(",")(n);
            return s.length < 6 ? s : d3.format("s")(n);
        };
        var minYear = d3.min(Object.keys(data), function(d) { return dateFormat.parse(d).getFullYear(); });
        var maxYear = d3.max(Object.keys(data), function(d) { return dateFormat.parse(d).getFullYear(); });

        var color = d3.scale.quantize().domain([0.0, 1.0])
                .range(d3.range(10).map(function(d) { return "q" + d + "-10"; }));

        const rootElement = d3.select("#" + elementId);
        var svg = rootElement.selectAll("svg")
                .data(d3.range(minYear, maxYear + 1))
                .enter().append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("class", "calendar-view")
                .append("g")
                .attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");

        svg.append("text")
                .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
                .style("text-anchor", "middle")
                .text(function(d) { return d; });

        var dayRects = svg.selectAll(".day")
                .data(function(d) { return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
                .enter().append("rect")
                .attr("class", "day")
                .attr("width", cellSize)
                .attr("height", cellSize)
                .attr("x", function(d) { return week(d) * cellSize; })
                .attr("y", function(d) { return day(d) * cellSize; })
                .datum(dateFormat);
        dayRects.append("title").text(function(d) { return d; });

        svg.selectAll(".month")
                .data(function(d) { return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
                .enter().append("path")
                .attr("class", "month")
                .attr("d", monthPath);

        var footerSpan = rootElement.append("span").style({float: "left", display: "block", width: (width - cellSize * 3) + "px"});
        var span = footerSpan.append("span").style({float: "right"});
        span.append("label").html("Color threshold: ");
        span.append("button").text("-").on("click", function () {
            threshold -= 5;
            if (threshold < 0) threshold = 0;
            console.log("threshold=" + threshold);
            data = parseRawData(rawData[rawDataIndex], threshold);
            updateDaysColor(dayRects, data);
        });
        span.append("button").text("+").on("click", function () {
            threshold += 5;
            if (threshold > 100) threshold = 100;
            console.log("threshold=" + threshold);
            data = parseRawData(rawData[rawDataIndex], threshold);
            updateDaysColor(dayRects, data);
        });
        span.append("button").text("reset").on("click", function () {
            threshold = 95;
            console.log("threshold=" + threshold);
            data = parseRawData(rawData[rawDataIndex], threshold);
            updateDaysColor(dayRects, data);
        });
        span.append("span").style({width: "20px", display: "inline-block"});
        span.append("label").html("Change size measured in: ");
        var dropDown = span.append("select");
        dropDown.append("option").attr("value", "0").html("commits");
        dropDown.append("option").attr("value", "1").html("lines");
        dropDown.append("option").attr("value", "2").html("characters");
        dropDown.on("change", function() {
            rawDataIndex = +this.value;
            data = parseRawData(rawData[rawDataIndex], threshold);
            updateDaysColor(dayRects, data);
        });


        updateDaysColor(dayRects, data);


        function updateDaysColor(dayRects, data) {
            dayRects.selectAll("title").text(function(d) { return d; });
            dayRects.filter(function(d){ return d in data; })
                    .attr("class", function(d) { return "day " + color(data[d].value); })
                    .select("title")
                    .text(function(d) { return "Date: " + d + "\nChange size: " + valueFormat(data[d].changeSize); });
        }

        function parseRawData(rawData, threshold) {
            var data = d3.csv.parse(rawData);
            data.forEach(function (d) { d.changeSize = +d.changeSize; });
            var toPercents = toPercentsFunction(data, threshold);

            return d3.nest()
                   .key(function(d) { return d.date; })
                   .rollup(function(d) { return {value: toPercents(d[0].changeSize), changeSize: d[0].changeSize}; })
                   .map(data);
        }

        function toPercentsFunction(data, threshold) { // TODO d3.quantile
            data.sort(function (a, b) { return a.changeSize < b.changeSize ? 1 : -1; });
            var length = data.length * (threshold / 100);
            var slicedData = data.slice(data.length - length, data.length);

            var min = d3.min(slicedData, function (d) { return d.changeSize; });
            var max = d3.max(slicedData, function (d) { return d.changeSize; });
            var rangeSize = (max - min > 0 ? max - min : 0.0000001);
            return function (value) {
                return (value - min) / rangeSize;
            };
        }

        function monthPath(t0) {
            var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
                    d0 = +day(t0), w0 = +week(t0),
                    d1 = +day(t1), w1 = +week(t1);
            return "M" + (w0 + 1) * cellSize + "," + d0 * cellSize
                    + "H" + w0 * cellSize + "V" + 7 * cellSize
                    + "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
                    + "H" + (w1 + 1) * cellSize + "V" + 0
                    + "H" + (w0 + 1) * cellSize + "Z";
        }
    }

    drawCalendarChart("calendar-view", rawData);

</script>