<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        font: 10px sans-serif;
        font-family: 'Lucida Grande','Calibri',Helvetica,Arial,sans-serif;
        background: #f2f2f2;
    }
</style>
<!--TODO diff d3.v2.min-2.js with existing d3 lib-->
<script src="d3.v2.min-2.js"></script>
<script src="d3.layout.cloud.js"></script>
<body>
    <span id="wordCloud"></span>
</body>
<script>
    var data = /*data_placeholder*/
    {
        words: [
            {text: "aaa", size: 300},
            {text: "aaa2", size: 300},
            {text: "aaa3", size: 300},
            {text: "bbb", size: 200},
            {text: "bbb2", size: 200},
            {text: "bbb3", size: 200},
            {text: "ccc", size: 100},
            {text: "ccc2", size: 100},
            {text: "ccc3", size: 100}
        ]
    }/*data_placeholder*/;

    createWordCloudOn("wordCloud");

    function createWordCloudOn(elementId) {
        var solidFill = d3.scale.category10();
        var mixedFill = d3.scale.category20();
        var width = 1200;
        var height = 900;

        var rootElement = d3.select("#" + elementId);
        var header = appendBlockElementTo(rootElement, width)
        header.append("h2").text("Commit messages word cloud")
                .style("text-align", "center")
                .style("margin-bottom", "30px");

        adjustSizeOfShortWords(data.words);
        normalizeWordSize(data.words);
        createWordCloud();

        function createWordCloud() {
            d3.layout.cloud()
                    .timeInterval(10)
                    .size([width, height])
                    .font("Impact")
                    .fontSize(function(d) { return d.size; })
                    .rotate(function(d) { return 0; })
                    .words(data.words.map(function(d) {
                        return {text: d.text, size: d.size};
                    }))
                    .on("end", draw)
                    .start();
        }

        function draw(words) {
            rootElement.select("svg").remove();
            rootElement.append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + width / 2.5 + "," + height / 2.5 + ")")
                    .selectAll("text")
                    .data(words)
                    .enter().append("text")
                    .style("font-size", function(d) { return d.size + "px"; })
                    .style("font-family", "Impact")
                    .style("fill", function(d, i) {
                        if (d.size > 50) return solidFill(i);
                        else return mixedFill(i);
                    })
                    .attr("text-anchor", "middle")
                    .attr("transform", function(d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                    })
                    .text(function(d) { return d.text; })
                    .on("click", function (d) {
                        if (!d3.event.altKey) return;
                        var words = data.words;
                        for (var i = 0; i < words.length; i++) {
                            var word = words[i];
                            if (word.text == d.text && word.size == d.size) {
                                words.splice(i, 1);
                                normalizeWordSize(data.words);
                                createWordCloud();
                                break;
                            }
                        }
                    });
        }

        function adjustSizeOfShortWords(words) {
            words.forEach(function (word) {
                if (word.text.length < 5) word.size = (word.size * 1.3);
            });
        }

        function normalizeWordSize(words) {
            var min = d3.min(words, function (d) { return d.size; });
            var max = d3.max(words, function (d) { return d.size; });
            var range = (max != min ? max - min : 1);
            words.forEach(function (word) {
                word.size = Math.round(5 + ((word.size - min) * 100 / range));
            });
        }

        function appendBlockElementTo(element, width) {
            return element.append("span")
                    .style("float", "left").style("display", "block").style("width", width + "px");
        }
    }
</script>